[
    #(load "fs" "io")

    (io/put "=== FS Advanced Operations Test ===\n\n")

    (def tmp_dir (fs/tmp))
    (def test_file (fs/join_path tmp_dir "test_advanced.txt"))

    (io/put "--- Test append mode ---\n")
    (def fid1 (fs/open "w" test_file))
    (assert (eq (eq fid1 -1) 0) "File should open")
    (def write1 (fs/write fid1 "First line\n"))
    (assert (eq (eq write1 -1) 0) "Write should succeed")
    (def close1 (fs/close fid1))
    (assert (eq close1 0) "Close should succeed")

    (def fid2 (fs/open "a" test_file))
    (assert (eq (eq fid2 -1) 0) "File should open in append mode")
    (def write2 (fs/write fid2 "Second line\n"))
    (assert (eq (eq write2 -1) 0) "Append write should succeed")
    (def close2 (fs/close fid2))
    (assert (eq close2 0) "Close should succeed")

    (def fid3 (fs/open "r" test_file))
    (assert (eq (eq fid3 -1) 0) "File should open")
    (def content (fs/read fid3))
    (assert (eq (eq content "") 0) "Content should not be empty")
    (io/put "Append mode: OK\n")
    (def close3 (fs/close fid3))
    (assert (eq close3 0) "Close should succeed")

    (io/put "\n--- Test read_bytes past EOF ---\n")
    (def fid4 (fs/open "r" test_file))
    (assert (eq (eq fid4 -1) 0) "File should open")
    (def seek_result (fs/seek fid4 0 2))
    (assert (eq (eq seek_result -1) 0) "Seek to end should succeed")
    (def read_past_eof (fs/read_bytes fid4 100))
    (assert (eq read_past_eof "") "Reading past EOF should return empty")
    (io/put "Read past EOF: OK\n")
    (def close4 (fs/close fid4))
    (assert (eq close4 0) "Close should succeed")

    (io/put "\n--- Test read_bytes with 0 count ---\n")
    (def fid5 (fs/open "r" test_file))
    (assert (eq (eq fid5 -1) 0) "File should open")
    (def read_zero (fs/read_bytes fid5 0))
    (assert (eq read_zero "") "Reading 0 bytes should return empty")
    (io/put "Read 0 bytes: OK\n")
    (def close5 (fs/close fid5))
    (assert (eq close5 0) "Close should succeed")

    (io/put "\n--- Test write after seek ---\n")
    (def fid6 (fs/open "w" test_file))
    (assert (eq (eq fid6 -1) 0) "File should open")
    (def write3 (fs/write fid6 "ABCDEF"))
    (assert (eq (eq write3 -1) 0) "Write should succeed")
    (def seek_result2 (fs/seek fid6 2 0))
    (assert (eq (eq seek_result2 -1) 0) "Seek should succeed")
    (def write4 (fs/write fid6 "XY"))
    (assert (eq (eq write4 -1) 0) "Write after seek should succeed")
    (def close6 (fs/close fid6))
    (assert (eq close6 0) "Close should succeed")

    (def fid7 (fs/open "r" test_file))
    (assert (eq (eq fid7 -1) 0) "File should open")
    (def content2 (fs/read fid7))
    (io/put "Content after write+seek: %s\n" content2)
    (def close7 (fs/close fid7))
    (assert (eq close7 0) "Close should succeed")

    (io/put "\n--- Test ls with multiple files ---\n")
    (def test_dir (fs/join_path tmp_dir "test_ls_dir"))
    (def mkdir_result (fs/mkdir test_dir))
    (assert (eq mkdir_result 0) "mkdir should succeed")

    (def file1 (fs/join_path test_dir "file1.txt"))
    (def file2 (fs/join_path test_dir "file2.txt"))
    (def file3 (fs/join_path test_dir "file3.txt"))

    (def fid8 (fs/open "w" file1))
    (assert (eq (eq fid8 -1) 0) "File should open")
    (def close8 (fs/close fid8))
    (assert (eq close8 0) "Close should succeed")

    (def fid9 (fs/open "w" file2))
    (assert (eq (eq fid9 -1) 0) "File should open")
    (def close9 (fs/close fid9))
    (assert (eq close9 0) "Close should succeed")

    (def fid10 (fs/open "w" file3))
    (assert (eq (eq fid10 -1) 0) "File should open")
    (def close10 (fs/close fid10))
    (assert (eq close10 0) "Close should succeed")

    (def ls_result (fs/ls test_dir))
    (def ls_list (cast :list-b ls_result))
    (def first_file (at 0 ls_list))
    (def second_file (at 1 ls_list))
    (def third_file (at 2 ls_list))
    (assert (eq (eq first_file "") 0) "First file should exist")
    (assert (eq (eq second_file "") 0) "Second file should exist")
    (assert (eq (eq third_file "") 0) "Third file should exist")
    (io/put "Directory contains 3 files\n")

    (def rmdir_result (fs/rmdir_recursive test_dir))
    (assert (eq (eq rmdir_result -1) 0) "rmdir_recursive should succeed")
    (io/put "Removed test directory\n")

    (io/put "\n--- Test join_path with many components ---\n")
    (def joined (fs/join_path "a" "b" "c" "d" "e" "f" "file.txt"))
    (io/put "Joined 7 components: %s\n" joined)
    (assert (eq (eq joined "") 0) "Join should succeed")

    (io/put "\n--- Test mkdir on existing directory ---\n")
    (def existing_dir (fs/join_path tmp_dir "existing_dir"))
    (def mkdir1 (fs/mkdir existing_dir))
    (assert (eq mkdir1 0) "First mkdir should succeed")
    (def mkdir2 (fs/mkdir existing_dir))
    (io/put "mkdir on existing dir: OK\n")

    (def rmdir_result2 (fs/rmdir existing_dir))
    (assert (eq rmdir_result2 0) "rmdir should succeed")

    (io/put "\n--- Test rename across directories ---\n")
    (def src_dir (fs/join_path tmp_dir "src_dir"))
    (def dst_dir (fs/join_path tmp_dir "dst_dir"))
    (def mkdir_src (fs/mkdir src_dir))
    (assert (eq mkdir_src 0) "mkdir should succeed")
    (def mkdir_dst (fs/mkdir dst_dir))
    (assert (eq mkdir_dst 0) "mkdir should succeed")

    (def src_file (fs/join_path src_dir "move_me.txt"))
    (def dst_file (fs/join_path dst_dir "moved.txt"))

    (def fid11 (fs/open "w" src_file))
    (assert (eq (eq fid11 -1) 0) "File should open")
    (def write5 (fs/write fid11 "content to move"))
    (assert (eq (eq write5 -1) 0) "Write should succeed")
    (def close11 (fs/close fid11))
    (assert (eq close11 0) "Close should succeed")

    (def rename_result (fs/rename src_file dst_file))
    (assert (eq rename_result 0) "Rename should succeed")
    (io/put "Renamed across directories: OK\n")

    (def exists_src (fs/exists src_file))
    (assert (eq exists_src 0) "Source should not exist")
    (def exists_dst (fs/exists dst_file))
    (assert (eq exists_dst 1) "Destination should exist")

    (def rmdir_result3 (fs/rmdir_recursive src_dir))
    (assert (eq (eq rmdir_result3 -1) 0) "rmdir_recursive should succeed")
    (def rmdir_result4 (fs/rmdir_recursive dst_dir))
    (assert (eq (eq rmdir_result4 -1) 0) "rmdir_recursive should succeed")

    (io/put "\n--- Cleanup ---\n")
    (def remove_result (fs/remove test_file))
    (assert (eq remove_result 0) "Remove should succeed")
    (io/put "Removed test file\n")

    (io/put "\n=== All advanced operations tests complete ===\n")
]

