[
    #(load "fs" "io")

    (io/put "=== FS File Modes Test ===\n\n")

    (def tmp_dir (fs/tmp))
    (def test_file (fs/join_path tmp_dir "test_modes.txt"))

    (io/put "--- Test r+ mode (read/write) ---\n")
    (def fid1 (fs/open "w" test_file))
    (assert (eq (eq fid1 -1) 0) "File should open")
    (def write1 (fs/write fid1 "Initial content\n"))
    (assert (eq (eq write1 -1) 0) "Write should succeed")
    (def close1 (fs/close fid1))
    (assert (eq close1 0) "Close should succeed")

    (def fid2 (fs/open "r+" test_file))
    (assert (eq (eq fid2 -1) 0) "File should open in r+ mode")
    (def read1 (fs/read fid2))
    (assert (eq (eq read1 "") 0) "Read should succeed")
    (def seek1 (fs/seek fid2 0 0))
    (assert (eq (eq seek1 -1) 0) "Seek should succeed")
    (def write2 (fs/write fid2 "Appended via r+\n"))
    (assert (eq (eq write2 -1) 0) "Write in r+ mode should succeed")
    (def close2 (fs/close fid2))
    (assert (eq close2 0) "Close should succeed")
    (io/put "r+ mode: OK\n")

    (io/put "\n--- Test w+ mode (write/read, truncate) ---\n")
    (def fid3 (fs/open "w+" test_file))
    (assert (eq (eq fid3 -1) 0) "File should open in w+ mode")
    (def write3 (fs/write fid3 "New content via w+\n"))
    (assert (eq (eq write3 -1) 0) "Write should succeed")
    (def seek2 (fs/seek fid3 0 0))
    (assert (eq (eq seek2 -1) 0) "Seek should succeed")
    (def read2 (fs/read fid3))
    (assert (eq (eq read2 "") 0) "Read in w+ mode should succeed")
    (def close3 (fs/close fid3))
    (assert (eq close3 0) "Close should succeed")
    (io/put "w+ mode: OK\n")

    (io/put "\n--- Test a+ mode (append/read) ---\n")
    (def fid4 (fs/open "a+" test_file))
    (assert (eq (eq fid4 -1) 0) "File should open in a+ mode")
    (def write4 (fs/write fid4 "Appended via a+\n"))
    (assert (eq (eq write4 -1) 0) "Append write should succeed")
    (def seek3 (fs/seek fid4 0 0))
    (assert (eq (eq seek3 -1) 0) "Seek to beginning should succeed")
    (def read3 (fs/read fid4))
    (assert (eq (eq read3 "") 0) "Read in a+ mode should succeed")
    (def close4 (fs/close fid4))
    (assert (eq close4 0) "Close should succeed")
    (io/put "a+ mode: OK\n")

    (io/put "\n--- Test invalid mode ---\n")
    (def fid5 (fs/open "xyz" test_file))
    (assert (eq fid5 -1) "Invalid mode should fail")
    (io/put "Invalid mode: OK\n")

    (io/put "\n--- Cleanup ---\n")
    (def remove_result (fs/remove test_file))
    (assert (eq remove_result 0) "Remove should succeed")
    (io/put "Removed test file\n")

    (io/put "\n=== All file modes tests complete ===\n")
]
