; Dynamic Evaluation Demonstration
; This script demonstrates core/expr/eval for runtime script evaluation
;
; Key concepts:
; - eval parses and executes script text at runtime
; - Enables building dynamic scripts from strings
; - Can evaluate expressions, function calls, or full scripts
; - Returns the result of evaluation (any type) or ERROR on failure
; - Useful for computed operations, templating, and meta-programming

{
  (core/util/log "=== Dynamic Evaluation Demo ===")
  (core/util/log "")
  
  ; PART 1: Basic expression evaluation
  
  (core/util/log "--- Part 1: Evaluating Expressions ---")
  (core/util/log "")
  
  (core/util/log "Simple literal:")
  (core/util/log "  (core/expr/eval \"42\") =>" (core/expr/eval "42"))
  (core/util/log "")
  
  (core/util/log "String literal:")
  (core/util/log "  Evaluating a quoted string")
  (core/util/log "")
  
  (core/util/log "Symbol:")
  (core/util/log "  (core/expr/eval \"test-symbol\") =>" (core/expr/eval "test-symbol"))
  (core/util/log "")
  
  ; PART 2: Evaluating function calls
  
  (core/util/log "--- Part 2: Evaluating Function Calls ---")
  (core/util/log "")
  
  (core/kv/set stored:key "some-value")
  
  (core/util/log "Eval a kv/get call:")
  (core/util/log "  Stored value:" (core/kv/get stored:key))
  (core/util/log "  Via eval:" (core/expr/eval "(core/kv/get stored:key)"))
  (core/util/log "")
  
  (core/util/log "Eval a kv/exists check:")
  (core/util/log "  (core/expr/eval \"(core/kv/exists stored:key)\") =>" (core/expr/eval "(core/kv/exists stored:key)"))
  (core/util/log "  (core/expr/eval \"(core/kv/exists nonexistent)\") =>" (core/expr/eval "(core/kv/exists nonexistent)"))
  (core/util/log "")
  
  ; PART 3: Building dynamic scripts
  
  (core/util/log "--- Part 3: Dynamic Script Construction ---")
  (core/util/log "")
  
  (core/util/log "Use case: Computed key access")
  (core/kv/set config:version "1.2.3")
  (core/kv/set config:name "sxs-runtime")
  (core/kv/set config:debug "false")
  (core/util/log "")
  
  (core/util/log "Building script to read config:version:")
  (core/kv/set dynamic:script "(core/kv/get config:version)")
  (core/util/log "  Script stored:" (core/kv/get dynamic:script))
  (core/util/log "  Eval result:" (core/expr/eval (core/kv/get dynamic:script)))
  (core/util/log "")
  
  ; PART 4: Eval with KV operations
  
  (core/util/log "--- Part 4: Eval + KV Patterns ---")
  (core/util/log "")
  
  (core/util/log "Pattern 1: Store operations as data")
  (core/kv/set ops:init "(core/kv/set counter 0)")
  (core/kv/set ops:increment "(core/kv/set counter 1)")
  (core/util/log "")
  
  (core/util/log "Executing stored operation: ops:init")
  (core/expr/eval (core/kv/get ops:init))
  (core/util/log "  counter after init:" (core/kv/get counter))
  (core/util/log "")
  
  (core/util/log "Executing stored operation: ops:increment")
  (core/expr/eval (core/kv/get ops:increment))
  (core/util/log "  counter after increment:" (core/kv/get counter))
  (core/util/log "")
  
  (core/util/log "Pattern 2: Templating / computed scripts")
  (core/kv/set template:prefix "user:")
  (core/kv/set user:alice "active")
  (core/kv/set user:bob "inactive")
  (core/util/log "")
  
  (core/util/log "Note: True templating requires string concatenation")
  (core/util/log "For now, eval with literal keys:")
  (core/util/log "  (core/expr/eval \"(core/kv/get user:alice)\") =>" (core/expr/eval "(core/kv/get user:alice)"))
  (core/util/log "")
  
  ; PART 5: Error handling
  
  (core/util/log "--- Part 5: Error Handling ---")
  (core/util/log "")
  
  (core/util/log "Eval of invalid syntax returns ERROR:")
  (core/util/log "  (core/expr/eval \"(unclosed paren\") => parse error")
  (core/util/log "")
  
  (core/util/log "Eval of unknown function returns ERROR:")
  (core/util/log "  (core/expr/eval \"(nonexistent/function)\") => unknown function")
  (core/util/log "")
  
  (core/util/log "Eval of missing key returns ERROR:")
  (core/util/log "  Result type: ERROR (but doesn't halt execution)")
  (core/util/log "")
  
  ; PART 6: Practical use cases
  
  (core/util/log "--- Part 6: Practical Use Cases ---")
  (core/util/log "")
  
  (core/util/log "Use Case 1: Configuration-driven behavior")
  (core/kv/set behavior:on_start "(core/util/log System started)")
  (core/util/log "  Stored startup behavior")
  (core/util/log "  Executing:")
  (core/expr/eval (core/kv/get behavior:on_start))
  (core/util/log "")
  
  (core/util/log "Use Case 2: Deferred execution")
  (core/kv/set deferred:task1 "(core/kv/set task1:status executed)")
  (core/kv/set deferred:task2 "(core/kv/set task2:status executed)")
  (core/util/log "  Tasks stored, not yet executed")
  (core/util/log "")
  (core/util/log "  Executing deferred tasks:")
  (core/expr/eval (core/kv/get deferred:task1))
  (core/expr/eval (core/kv/get deferred:task2))
  (core/util/log "  task1:status:" (core/kv/get task1:status))
  (core/util/log "  task2:status:" (core/kv/get task2:status))
  (core/util/log "")
  
  (core/util/log "=== Demo Complete ===")
  (core/util/log "")
  (core/util/log "Key Takeaways:")
  (core/util/log "- eval executes script text at runtime")
  (core/util/log "- Enables meta-programming and configuration-driven behavior")
  (core/util/log "- Can store operations as data and execute later")
  (core/util/log "- Returns ERROR on parse/eval failure (doesn't halt)")
  (core/util/log "- Combine with KV for powerful dynamic patterns")
}


