[
    #(load "fs" "io")

    (io/put "=== FS Directory Operations Test ===\n\n")

    (def tmp_dir (fs/tmp))
    (def test_dir (fs/join_path tmp_dir "test_dir"))
    (def test_subdir (fs/join_path test_dir "subdir"))
    (def test_nested (fs/join_path test_subdir "nested"))

    (io/put "--- Test mkdir (single level) ---\n")
    (def mkdir_result (fs/mkdir test_dir))
    (assert (eq mkdir_result 0) "mkdir should succeed")
    (io/put "Created directory\n")

    (def exists1 (fs/exists test_dir))
    (assert (eq exists1 1) "Directory should exist")
    (io/put "Directory exists: %d\n" exists1)

    (io/put "\n--- Test mkdir (nested, recursive) ---\n")
    (def mkdir_result2 (fs/mkdir test_nested))
    (assert (eq mkdir_result2 0) "Recursive mkdir should succeed")
    (io/put "Created nested directory\n")

    (def exists2 (fs/exists test_nested))
    (assert (eq exists2 1) "Nested directory should exist")
    (io/put "Nested directory exists: %d\n" exists2)

    (io/put "\n--- Test ls (list directory) ---\n")
    (def ls_result (fs/ls test_dir))
    (def ls_list (cast :list-b ls_result))
    (def first_entry (at 0 ls_list))
    (io/put "Directory contains: %s\n" first_entry)

    (io/put "\n--- Test rmdir (empty directory) ---\n")
    (def rmdir_result (fs/rmdir test_nested))
    (assert (eq rmdir_result 0) "rmdir should succeed on empty dir")
    (io/put "Removed empty nested directory\n")

    (def exists3 (fs/exists test_nested))
    (assert (eq exists3 0) "Directory should not exist after rmdir")
    (io/put "Directory exists after rmdir: %d\n" exists3)

    (io/put "\n--- Test rmdir_recursive (directory with contents) ---\n")
    (def test_file (fs/join_path test_subdir "file.txt"))
    (def fid (fs/open "w" test_file))
    (assert (eq (eq fid -1) 0) "File should open")
    (def write_result (fs/write fid "test content"))
    (assert (eq (eq write_result -1) 0) "Write should succeed")
    (def close_result (fs/close fid))
    (assert (eq close_result 0) "Close should succeed")
    (io/put "Created file in subdir\n")

    (def rmdir_recursive_result (fs/rmdir_recursive test_dir))
    (assert (eq (eq rmdir_recursive_result -1) 0) "rmdir_recursive should succeed")
    (io/put "Removed directory recursively (count: %d)\n" rmdir_recursive_result)

    (def exists4 (fs/exists test_dir))
    (assert (eq exists4 0) "Directory should not exist after rmdir_recursive")
    (io/put "Directory exists after rmdir_recursive: %d\n" exists4)

    (io/put "\n=== All directory operations tests complete ===\n")
]

